
---
output: 
  pdf_document:
    includes:
      before_body: portada.tex
      in_header: 
    toc: true
    number_sections: false
    toc_depth: 3
  tables: true
include-before:
- '`\newpage{}`{=latex}'
toc-title: Contenido
urlcolor: blue
header-includes:
- \usepackage[nottoc]{tocbibind}
- \renewcommand{\listfigurename}{Lista de figuras}
- \renewcommand{\listtablename}{Lista de tablas}
- \usepackage[utf8]{inputenc}
- \usepackage[spanish]{babel}
- \usepackage{graphicx}
- \usepackage{float}
- \usepackage{pdfpages}

---

\newpage

\clearpage


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=F, message=FALSE, warning=FALSE, 
                       fig.align='center', eval=T)
pacman::p_load(tidyverse, tinytex, kableExtra, phaseR, latex2exp, dplyr, tidyr, ggplot2,readxl, writexl, readr,foreign, msm,lubridate,zoo, janitor,hexbin, magrittr, broom, fOptions, derivmkts, Hmisc, reshape, reshape2, stargazer, viridis, readxl,  scales,
               knitr,lubridate, ggfortify, gridExtra)
```


## Ejercicio 2 Estudie el financiamiento del sistema bancario en México a la luz del concepto de "transformación de madurez": [2 horas, 1 puntos cada inciso]

### (a)
**Obtenga, del SIE/Financiamiento e información financiera de intermediarios financieros/ del Banco de México, información de las formas de financiamiento del sector bancario (comercial) mexicano, y haga gráficas describiendo la evolución en el tiempo de las distintas tipos de financiamiento (depósitos a la vista, financiamiento de mercado y otros) y de la proporción que cada uno representa del total. Es decir, hay que producir dos gráficas de series de tiempo en la que el valor total está constituido por varias partes intermedias.**


```{r 2a, }

siae <- readxl::read_xlsx("siae.xlsx")
inpp <- readxl::read_xls("inpp.xls")
inpp <- inpp[,-1]

siae2 <- cbind(siae,inpp)
siae2 <- siae2[,c(-1,-8)]

siaedef <- (siae2/siae2[,47])*100


siaet <- ts(siaedef, frequency = 12, start = c(2009,07))

siaeprop <- ts((siae2[,17:47]/siae2[,17])*100,frequency = 12, start = c(2009,07))

```


Buscamos en el Sistema de Información Económica de Banco de México, en el apartado de financiamiento e información financiera de intermediarios financieros, cifras sobre las fuentes de financiamiento de la banca comercial. En la base de datos encontramos que el Banco de México divide los pasivos de la banca comercial en diversos rubros, pero los que pueden ser considerados como fuentes de financiamiento son:

  - Captación: Para que las instituciones de crédito (bancos múltiples y bancos de desarrollo) cumplan su función de intermediación, requieren captar recursos, tanto del público en general, como de otros bancos y entidades no financieras. En este apartado se agregan los rubros de captación al público en general como; Depósitos de exigibilidad inmediata; Depósitos a plazo; Nóminas; entre otras. 
  
  - Acreedores por reporto de valores: Es una operación de crédito en virtud de la cual el reportador, en este caso la banca de desarrollo, Banco de México, y otras instituciones financieras adquieren por una suma de dinero la propiedad de títulos de crédito, y se obliga a transferir al reportado la propiedad de otros tantos títulos de la misma especie, en el plazo convenido y contra reembolso del mismo precio, más un premio. 
  
  - Financiamiento Interno: Importe que recibe la banca comercial en efectivo o en especie de acreedores nacionales y que son, además, motivo de autorización y registro por parte de la Secretaría de Hacienda y Crédito Público, sin importar el tipo de moneda en que se documenten.
  
  - Financiamiento Externo: Importe que recibe la banca comercial en efectivo o en especie de acreedores extranjeros y que son, además, motivo de autorización y registro por parte de la Secretaría de Hacienda y Crédito Público, sin importar el tipo de moneda en que se documentan.
  
En la siguiente gráfica se presenta el comportamiento de estos cuatro conceptos de 2009 a 2022, deflactado a julio de 2019 con el Índice Nacional de Precios al Productor (INPP) para tener precios constantes y comparables en todo el periodo.


```{r 2ai,fig.cap="Fuentes de financiamiento de la banca comercial, 2009M07-2022M03", fig.pos='H'}

options(repr.plot.width = 1, repr.plot.height = 0.75)
autoplot(scale(siaet[,c(18,34,41,45)]),facets = FALSE) + labs(colour = "Fuentes",caption = "Nota: Series normalizadas para ser visualmente comparables") + theme(legend.position="bottom") + geom_hline(yintercept=0) 

```
  
A pesar de que las series están normalizadas con el siguiente método $(\frac{x_i-\bar{X}}{\sigma_x})$, podemos observar su comportamiento a lo largo del periodo. Podemos notar que las fuentes de financiamiento que más aumentaron desde 2009 fueron la Captación y el financiamiento interno. Mientras que el financiamiento externo y la parte de acreedores por reporto mantuvieron un comportamiento a la baja. 

Podemos ver que el comportamiento de acreedores y del financiamiento ha mantenido un comportamiento errático, terminando por debajo de su nivel inicial. Es importante destacar el comportamiento que han tenido las variables alrededor de las crisis, por ejemplo, vemos que los bajos niveles del inicio de la muestra se deben a la gran recesión de 2009. A partir de ahí vemos una recuperación paulatina, pero que con la llegada de la pandemia revertiría este comportamiento y solo la captación mantuvo su crecimiento. 

Es importante hacer un análisis de la proporción que representa cada una de estas cuatro cuentas dentro de los pasivos totales de la banca comercial en México. En la siguiente figura se muestra la proporción que representa acreedores y captación (de lado izquierdo) y el financiamiento externo e interno (de lado derecho).
 

```{r 2aii,fig.cap="Proporción del financiamiento de la banca comercial, 2009M07-2022M03", fig.pos='H'}


p1<- autoplot(siaeprop[,c(2,18)],facets = FALSE) + labs(colour = "Fuentes",caption = "Nota: Como proporción del total de financiamiento") + theme(legend.position="bottom")

p2<- autoplot(siaeprop[,c(25,29)],facets = FALSE) + labs(colour = "",caption = "") + theme(legend.position="bottom")

grid.arrange(p1, p2, nrow = 1)
```

Lo primero que hay que destacar es que la dependencia del financiamiento a través de la captación por parte de la banca comercial ha ido aumentando. Captación representaba poco más del 50$\%$ del total de los pasivos al inicio, sin embargo, mantuvo una fuerte tendencia creciente que se explica también por la importante caída registrada en los demás rubros (principalmente acreedores) cerrando el período con una proporción del 71$\%$.

Otra cosa que llama la atención es la poca participación que tienen los conceptos de financiamiento externo e interno sobre los pasivos totales de la banca comercial. Ambas series se comportaron como ruido blanco, es decir que oscilaron alrededor de una media. El salto que se observa en el financiamiento interno se explica por un salto que hubo del crédito que otorgó Banco de México, ya que de marzo a abril del 2020 el financiamiento creció 74 veces. Según un informe de Banco de México fue con la intención de promover un comportamiento ordenado de los mercados financieros, fortalecer los canales de otorgamiento de crédito y proveer liquidez para el sano desarrollo del sistema financiero ante la pandemia. 

Lo anterior, con el fin de reducir la posibilidad de que las instituciones de la banca comercial tengan un comportamiento procíclico, y de crear las condiciones que faciliten que estas instituciones puedan cumplir su función prioritaria de proveer financiamiento a la economía, para que a su vez este pueda destinarse a las micro, pequeñas y medianas empresas, así como a los hogares que han visto una reducción transitoria de sus fuentes de ingreso. En su conjunto, las acciones aprobadas por el Banco de México apoyaron el funcionamiento del sistema financiero hasta por 750 mil millones de pesos. Al sumarse a lo ya implementado, el total fue equivalente al 3.3% del PIB de 2019. Lo anterior demuestra la preocupación de la banca central por la posibilidad de que se generen problemas de liquidez y con ello una corrida bancaria.

```{r 2aiii,fig.cap="Comportamiento de las principales fuentes de financiamiento, 2009M07-2022M03", fig.pos='H'}

siaecap <- ts((siaet[,18:33]/siaet[,18])*100, names = c(1:16), start=c(2009, 07), frequency=12 )
siaeacre <- ts(((siaet[,34:40])/siaet[,34])*100, names = c(1:7),start=c(2009, 07), frequency=12)
siaeint <- ts(((siaet[,41:44])/siaet[,41])*100, names =c(1:4),start=c(2009, 07), frequency=12)


p3 <- autoplot(siaecap[,c(2,5,8,11,14)],facets = FALSE,ts.geom = 'bar',stacked = TRUE) + theme(legend.position="left", legend.title = element_blank())

p4 <- autoplot(siaeacre[,2:7],facets = FALSE) + labs(colour = "",caption = "") + theme(legend.position="right")

p5 <- autoplot(siaeacre[,2:4],facets = FALSE) + labs(colour = "",caption = "") + theme(legend.position="left")

p6 <- autoplot((siaet[,45]/siaet[32,45])*100,facets = FALSE) + labs(colour = "",caption = "") + theme(legend.position="right")
  
grid.arrange(p3, p4, p5,p6, nrow = 2, ncol=2,  heights=c(3,3), widths=c(2,2))


```

Para complementar el análisis, presentamos la figura anterior que muestra el comportamiento de los componentes de cada una de las cuatro cuentas que contemplamos para ver el fondeo de la banca comercial. Se anexa un cuadro con los nombres correspondientes a cada número y a cada cuenta. En la esquina superior izquierda, podemos ver el comportamiento de los componentes de la captación, en donde destaca que el sector no bancario residente (mayormente depósitos a la vista), constituye cerca del 90$\%$ de los fondos, y la segunda cuenta relevante es el sector público no financiero con aproximadamente el otro 10$\%$.

Para el caso de la esquina superior derecha tenemos el comportamiento de los componentes de acreedores, donde la participación se concentra en el Banco de México y la banca de desarrollo. Para el caso del financiamiento interno, también tenemos lo mismo que en el caso anterior. Finalmente, no existe una desagregación para el financiamiento externo, que se presenta en la esquina inferior derecha.

## (b)
**Obtenga de la misma fuente información del tipo de créditos que el sistema bancario (comercial) mexicano otorga, y haga gráficas describiendo la evolución en el tiempo de distintos tipos de crédito y de la proporción que cada uno representa del total. Al igual que en el inciso anterior, hay que producir dos gráficas de series de tiempo en la que el valor total está constituido por varias partes intermedias.**

Para el desarrollo de este inciso se utilizó información sobre la cartera vigente otorgada al sector privado no bancario . En específico, se uso la cartera vigente total por destino de crédito que se divide en las siguientes categorías:
\begin{itemize}
  \item Consumo
  \item Vivienda
  \item Empresas
\end{itemize}

Cada categoría se divide en sub-categorias, sin embargo, para este inciso solo se usan la clasificación más general. 

En la figura \ref{fig:g2} podemos ver la proporción respecto a la cartera total, por tipo de crédito. Podemos destacar que la proporción se ha mantenido relativamente estable; con el crédito al consumo y el crédito a la vivienda ocupando un 25\% cada uno y el crédito empresarial un 50\%
Además, en la figura \ref{fig:g3} vemos, en términos nominales, el monto de la cartera por tipo de crédito.

  
```{r g2,out.height="220px", fig.cap="Proporción por tipo de crédito de la cartera total", fig.pos='H', fig.width=12, fig.height= 5}
datb  <- read_csv("ej2t4.csv") #carga de la base
colnames(datb) <- c("Fecha","Consumo", "t_crédito", "Nómina", "Personales", "Consumo_duradero", "Otros", "Vivienda", "interes_social", "residencial", "Empresarial") #cambiamos los nombres
#Creación de variables
datb$Total <- datb$Consumo + datb$Vivienda + datb$Empresarial 
datb$Prop_consumo <- datb$Consumo/datb$Total
datb$Prop_vivienda <- datb$Vivienda/datb$Total
datb$Prop_empresarial <- datb$Empresarial/datb$Total
datb$Fecha <- as.Date(datb$Fecha, format = "%d/%m/%y")

#gráfica
datb %>% select(Fecha, Prop_consumo, Prop_vivienda, Prop_empresarial) %>% gather(variable, value, Prop_consumo:Prop_empresarial) %>% ggplot(aes(x= Fecha, y = value, fill= variable))+ geom_area()+ scale_fill_brewer(palette="PuRd") + ylab("Proporción") + theme_bw()

```

```{r g3,out.height="220px", fig.cap="Cartera de crédito", fig.pos='H', fig.width=12, fig.height= 5}
datb %>% select(Fecha, Consumo, Vivienda, Empresarial) %>% gather(variable, value, Consumo:Empresarial) %>% ggplot(aes(x= Fecha, y = value, fill= variable))+ geom_area() + scale_fill_brewer(palette="PuRd") + theme_bw() + ylab("Proporción") + xlab("monto")
```




##(c)
**Explique si los datos son consistentes con la hipótesis de que los bancos hacen transformación de madurez o si no lo son y porqué. Para ello posiblemente tenga que hacer supuestos (razonables) o buscar información adicional acerca de la madurez de los distintos tipos de financiamiento y crédito otorgado.**


```{r ci,}

plazo <- ts(readxl::read_xlsx("madurez.xlsx"), frequency = 12, start = c(2012,12))

propplaz <- ts((plazo[,3:4]/plazo[,2])*100, frequency = 12, start = c(2012,12), names = c("Corto", "Largo"))



Corto <- ((siae[,22] +  siae[,25] + siae[,28] +siae[,31] + siae[,34])/siae[,20])*100

Largo <- ((siae[,23] +  siae[,26] + siae[,29] +siae[,32] + siae[,35])/siae[,20])*100

pasplaz <- cbind(Corto, Largo)
colnames(pasplaz) <- c("Corto", "Largo")

pasplaz <- ts(pasplaz[42:153,], frequency = 12, start = c(2012,12))


p7 <- autoplot(propplaz ,facets= FALSE,ts.geom = 'ribbon',stacked = TRUE) + theme(legend.title = element_blank(), legend.position = "none") 

p8 <- autoplot(pasplaz ,facets= FALSE,ts.geom = 'ribbon',stacked = TRUE) + theme(legend.title = element_blank(), legend.position = "bottom") 

grid.arrange(p7, p8, nrow = 1, ncol= 2)

```

En la gráfica del lado izquierdo se presenta la proporción de corto y largo plazo de la tenencia de emisiones de deuda en el mercado local en manos de la banca comercial. En el lado derecho, las obligaciones de la banca comercial por plazo. Supondremos que los activos en tenencia de emisiones de deuda reflejan los proyectos de inversión que realizan estas instituciones y que las obligaciones reflejan el financiamiento total que perciben. 

Si analizamos el caso de las inversiones que realiza la banca comercial por tipo de periodicidad, podemos notar que aproximadamente el 85$\%$ es de largo plazo. A pesar de que no contamos con información más detallada con respecto a la madurez puntual de las inversiones, sí podemos decir que la banca comercial no puede disponer de manera inmediata de los recursos que ha prestado o comprometido. Esta alta concentración en las inversiones de largo plazo se ha mantenido para toda la muestra, ya que a pesar de que termina en un nivel menor no es una diferencia significativa. 

Por otro lado, en el caso de la periodicidad de las fuentes de fondeo de la banca comercial podemos notar una alta concentración en los fondos de corto plazo. Esto quiere decir que más de la mitad de los recursos de la banca comercial provienen de fuentes de las cuales los acreedores pueden disponer de forma inmediata. Al inicio del periodo, se observa una concentración de poco más del 55$\%$ pero al final del periodo este nivel alcanza el 70$\%$.

Dado el comportamiento particular de ambos casos podemos rescatar una idea central que propone el modelo Diamon-Dybvig, donde la probabilidad de una corrida bancaria aumenta en función del descalce de la madurez entre los pasivos y activos del sistema bancario. En el siguiente inciso haremos un análisis más exhaustivo de las implicaciones que puede tener que se presente a largo plazo y se fondeé a corto plazo, dentro del modelo mencionado anteriormente.

## (d)
**Explique qué implica la evolución de las formas de financiamiento y los tipos de crédito otorgados que observó en los incisos anteriores para la estabilidad del sistema financiero a la luz del modelo Diamond-Dybvig.**

Como mencionamos anteriormente, existe una transformación de madurez de la banca comercial, esto quiere decir que reciben fondeo de corto plazo y lo invierten en proyectos de largo plazo. A este fenómeno se le conoce como *Maturity mismatch*, lo que quiere decir que hay descalce de vencimientos. El modelo Diamond-Dybvig plantea que hay una demanda de activos que se asemejan a los depósitos a la vista tradicionales. Es decir, los activos se pueden retirar en cualquier momento.

Luego muestran que, si la inversión es en proyectos de largo plazo, una institución financiera que recibe depósitos a la vista es vulnerable a las corridas bancarias. Podemos decir que, de acuerdo con el modelo, para el caso de la banca comercial mexicana se ha ido incrementando el riesgo de una corrida bancaria, ya que realiza prestamos de largo plazo, y recibe fondos de corto plazo. Entonces, cuando exista un incremento de los retiros de los depósitos en los bancos, los bancos no van a poder liquidar los fondos de inversión de largo plazo para cumplir con sus obligaciones. 

Adicionalmente, deberíamos revisar cual es el valor de sus deberes y haberes, lo que nos indicaría si existe un grado de apalancamiento que aumente de forma adicional el riesgo. Por ejemplo, para marzo de 2022 el valor de las tenencias de deuda de largo plazo por parte de la banca comercial fue de 1,425 mil millones de pesos mientras que las obligaciones de corto plazo fueron por un valor de 4,752 mil millones de pesos. Notamos entonces que el grado de apalancamiento es de apenas el 30%, esto quiere decir que solo utilizan poco menos de un tercio de los fondos que recién para sus proyectos de largo plazo. En otras palabras, esto ayuda a contrastar el pronóstico que hace el modelo Diamond-Dybvig, ya que la exposición de la banca comercial no es grande. 

Es probable, que en caso de una posible corrida bancaria el Banco de México inyecte liquidez suficiente para controlar el temor de los depositantes tal y como se observamos en abril de 2020.

## (e)
**A propósito, documente el incremento dramático a lo largo del tiempo en el crédito hipotecario como proporción del PIB.**

A partir de la información publicada por el Banco de México sobre la cartera vigente otorgada al sector privado no bancario (CF835), se obtuvo información sobre el crédito destinado a vivienda; que se divide en crédito a vivienda de interés social y crédito para vivienda media y residencial.
Además, se obtuvieron datos del pib desestacionalizado a precios constantes (año base 2013) para el periodo del 2003 al 2021. De esta forma podemos comparar la cartera vigente destinada a vivienda con el PIB.
Es importante recalcar que la cartera vigente otorgada al sector privado está dada a precios corrientes del 2019, por lo que está serie fue deflactada para llevarla a precios de 2013 y que de esta forma las series sean comparables. También, se promedio la cartera de créditos hipotecarios por trimestre ( ya que los datos son de corte mensual). 

$$
C_hipoteca_{2013} = \frac{Crédito_{t}}{IPP_{t,2013}}*100
$$

En la gráfica \ref{fig:g4} vemos el PIB y la cartera de crédito destinada a la vivienda.

Además, en la figura \ref{fig:g5} se presenta la evolución del crédito hipotecario como proporción del PIB desde el año 2003. Podemos destacar el "boom´´ del crédito a la vivienda desde el 2005 hasta el 2008, pasando de un 4\% a un 8\% aproximadamente; después de ese periodo, la proporción se mantiene más estable, mostrando un crecimiento más gradual hasta el 2019 pasando del 8\% al 11\% (esta desacelaración se explica por la crisis inmobiliaria).Además, En el 2019 se aprecia una subida de la proporción del crédito hipotecario, esto gracias a la caída del PIB por la pandemia y no por un aumento de los créditos.
```{r  }

ipp <- read_csv("ipp.csv")
pib <- read_csv("pib_t42.csv") 
ipp$Periodo <- as.yearqtr(ipp$Periodo,"%Y/%m") 

ipp <- ipp %>% #agrupamos la cartera por trimestre.
  mutate(year = year(Periodo), Q = quarter(Periodo)) %>%
  group_by(year, Q) %>%
  summarise(mean(IPP))
ipp <-unite(ipp, variables,c(1:2),  sep = "/", remove = TRUE) 
ipp <- dplyr::rename(ipp, c( "fecha" ="variables", "IPP"="mean(IPP)"))
ipp$fecha  <- as.yearqtr(ipp$fecha, "%Y/%q")
ipp$indice <- (ipp$IPP/76.48502)*100



hip <- datb %>% #agrupamos la cartera por trimestre.
  mutate(year = year(Fecha), Q = quarter(Fecha)) %>%
  group_by(year, Q) %>%
  summarise(mean(Vivienda)) 

#formato a la nueva base
hip <-unite(hip, variables,c(1:2),  sep = "/", remove = TRUE) 

hip <- dplyr::rename(hip, c("fecha"="variables", "c_hipotecario"= "mean(Vivienda)"))
hip$fecha  <- as.yearqtr(hip$fecha, "%Y/%q")

#carga del pib

pib$fecha <- as.yearqtr(pib$fecha, "%Y/%q") #formato a la fecha
hip <- merge(hip, pib, by = "fecha") #Unimos la base de datos
hip <- merge (hip, ipp, by = "fecha")
hip$credito_deflactado <- hip$c_hipotecario/hip$indice
hip$proporcion <- (hip$credito_deflactado/hip$PIB)*100 #creamos variable para graficar

```

```{r g4, out.height="220px", fig.cap="PIB y crédito hipotecario", fig.pos='H', fig.width=12, fig.height= 5}
df <-  melt(hip, id.vars ="fecha") 
ggplot(df, aes(x= fecha, y = value, color = variable, group=variable))+
  geom_line()+ theme_grey()+ xlab("Periodo")+ ylab("") + scale_y_continuous() + theme_bw()
```




```{r g5,out.height="220px", fig.cap="Proporción del crédito hipotecario respecto al PIB", fig.pos='H', fig.width=12, fig.height= 5}
hip %>% ggplot(aes(x= fecha, y = proporcion))+ geom_area(fill = "lightpink", color = "darkblue") + theme_bw() + ylab("Proporción") + xlab("Periodo")
```




\newpage
## Anexo

```{r anexo, echo= FALSE}

sd <- data.frame("Núm"=2:14, "Captación" =c("No bancario residente ","","","Banca de desarrollo","","","Intermediarios financieros","","","Sector público no financiero","","","No residente"), "Acreedores"=c("Banco de México","Banca de desarrollo","Sector privado no bancario residente","Otros intermediarios"," Sector público no financiero","Sector no residente","","","","","","",""), "Interno"=c("Banco de México","Banca de desarrollo","Otros intermediarios","","","","","","","","","",""))



kbl(sd, booktabs = T,  caption = "A1. Nombres de las variables") %>%
kable_styling(position = "center",latex_options = c("striped", "hold_position"))



```



